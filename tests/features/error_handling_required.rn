// Tests explicit try/catch handling and propagation of typed errors.

import ensure from "test_support/ensure"
let ensure = ensure.ensure

error IoError = enum { NetworkFailure, PermissionDenied }

fn fetch_resource(path: Str) IoError!Str {
  if path == "/ok" {
    return "resource:${path}"
  }
  if path == "/denied" {
    return error.IoError.PermissionDenied
  }
  return error.IoError.NetworkFailure
}

fn bootstrap() IoError!Str {
  // The happy-path call propagates any unexpected errors automatically.
  let _ = try fetch_resource("/ok")

  // Explicitly attempt a failing action so the caller must handle it.
  return try fetch_resource("/denied")
}

let recovered = bootstrap() catch |err| {
  match err {
    error.IoError.PermissionDenied => {
      echo "Permission denied, recovering with cached data"
      return "cached"
    }
    else => {
      echo "Unexpected bootstrap failure: ${err}"
      return "unknown"
    }
  }
}

ensure(recovered == "cached", "caller recovers from handled error")

echo "mandatory error handling test passed"
