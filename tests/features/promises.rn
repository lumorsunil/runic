// Tests async promises, ^T types, await capture blocks, and typed errors.

const ensure_module = import("test_support/ensure")
const ensure = ensure_module.ensure

error PromiseError = enum { Timeout }

fn async_sum(lhs: Int, rhs: Int) ^Int {
  async {
    let total = lhs + rhs
    return total
  }
}

fn async_fail() ^PromiseError!Int {
  async {
    return error.PromiseError.Timeout
  }
}

const pending = async_sum(2, 3)
await (pending) |value| {
  ensure(value == 5, "await unwraps resolved value")
}

const failing = async_fail()
await (failing) |value| {
  echo "Unexpected success ${value}"
  exit 1
} catch |err| {
  ensure(err == error.PromiseError.Timeout, "await surfaces typed errors")
}

echo "promises test passed"
